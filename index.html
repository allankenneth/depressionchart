<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Depression Chart</title>
<meta name="description" content="Depression Chart: Keep track of your major depression inventories. Track, share, get better.">
<meta name="author" content="Allan Haggett">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/bootstrap.min.css">
<style>
body {padding: 4.5em 0; }
label {color: #666; display: block;}
.nav-link {padding: .3em;}
.question {margin: 3em 0;}
.questiontext {font-size: 1.6em; font-weight: 200; margin: 0 0 .5em 0;}
</style>
</head>
<body class="bg-light">
<nav id="inventory-questions" class="navbar fixed-top navbar-light bg-white">
	<span class="navbar-brand">Depression Chart</span>
</nav>
<div class="container-fluid">
<div class="row nogutter justify-content-md-center">
<div class="col-md-8">
	<a href="questionnaire.html" class="mt-0 mb-3 bounce-top btn btn-primary btn-lg btn-block">Answer the Questions</a>
	<div class="mb-0 results"></div>
	<div class="row mx-0 mb-0 mt-0">
		<div style="border-top-left-radius: 5px; " class="col p-0 text-white bg-success"></div>
		<div class="col p-0 text-white bg-success">5</div>
		<div class="col p-0 text-white bg-success">10</div>
		<div class="col p-0 text-white bg-success">15</div>
		<div class="col p-0 text-white bg-warning">20</div>
		<div class="col p-0 text-white bg-danger">25</div>
		<div class="col p-0 text-white bg-dark">30</div>
		<div class="col p-0 text-white bg-dark">35</div>
		<div class="col p-0 text-white bg-dark">40</div>
		<div style="border-top-right-radius: 5px" class="col p-0 text-white bg-dark">45</div>
	</div>
	<div class="row mx-0 mb-3 text-center" style="font-size: 10px">
		<div style="border-bottom-left-radius: 5px" class="col text-white bg-success">Not</div>
		<div class="col text-white bg-warning">Mild</div>
		<div class="col text-white bg-danger">Moderate</div>
		<div style="border-bottom-right-radius: 5px" class="col text-white bg-dark">Severe</div>
	</div>
	<div class="row justify-content-md-center">
		<div class="col-md-6 mt-3">
			<p>These questions are designed to screen for major depressive disorder; not designed to take the place of a professional diagnosis or consultation. If your score indicates that you might have depressive disorder please contact with a qualified mental health care professional for further clinical evaluation.</p>
		</div>
	</div>
	</div> <!-- /.container -->

</div>
<div class="modal fade" id="answersModal" tabindex="-1" role="dialog" aria-labelledby="answersModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
<div class="modal-content">
	<div class="modal-header">
		<div class="text-center">In the two weeks prior to</div>
		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
			<span aria-hidden="true">&times;</span>
		</button>
	</div>
	<div class="modal-body">

		<h4 class="text-center" id="dateTestModal">January 1st 2020</h4>
		<p class="text-center mb-1">Your answers indicated that you may be:</p>
		<div id="answerSet"></div>

	</div>
	<div class="modal-footer">
		<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
	</div>
</div>
</div>
</div>

<script src="/jquery.min.js"></script>
<script src="/bootstrap.min.js"></script>
<script src="/pouchdb.min.js"></script>

<script>
$(document).ready(function(){

var html = '';
var count = 0;
var scores = [];

var extremeColor = '#D9534F';
var moderateColor = '#F0AD4E';
var mildColor = '#5CB85C';
var barColor = '';

var db = new PouchDB('inventories');

db.allDocs({include_docs: true, descending: true}, function(err, doc) {
	doc.rows.forEach(function(e,index){
		
		var options = { month: 'short', day: 'numeric' }
		d = new Date(parseInt(e.doc['date'])).toLocaleDateString("en-US", options);
		total = e.doc['score'];
		level = getLevel(total);
		width = parseInt(total) * 2;
		html += '<div style="border-radius: 5px; height: 50px; width:' + width;
		html += '%;" class="assessment p-2 text-white '+ level +'">';
		html += '<a class="invdel float-left mt-1 mr-2 mb-0 mr-0" href="#';
		html += parseInt(e.doc['date']) + '" style="color:#FFF">x</a>';
		html += '<a href="#" data-toggle="modal" data-target="#answersModal" data-key="';
		html += parseInt(e.doc['date']) + '"';
		html += 'class="score float-right" style="color:#FFF;display: inline-block;height: 20px;';
		html += 'width: 20px; font-size: 24px; margin-right: 10px; text-align: right;">';
		html += total + '</a>';
		html += '<small class="text-center " style="display: inline-block; margin-top: 6px; ';
		html += 'line-height: 1em; text-align: center; text-transform: uppercase; width: 20px;">';
		html += d  + '</small>';
		html += '</div>';
		scores.push(e.doc['score']);
		count++;
	});
	if(count==0) {
		html = '<div class="alert alert-dark mb-3" role="alert">No results to show yet.</div>';
	}
	$('.results').html(html);
	$('[data-toggle="tooltip"]').tooltip();

});


$('body').on('click','a.invdel',function(e){
	e.preventDefault();
	//$(this).parents('.assessment').tooltip('disable');
	mydoc = $(this).attr('href');
	docid = mydoc.split('#');
	did = docid[1];
	db.get(did).then(function (doc) {
	  return db.remove(doc);
	});
	$(this).parents('.assessment').remove();
});



$('#answersModal').on('show.bs.modal', function (event) {

	var button = $(event.relatedTarget);
	var did = button.data('key').toString(); 
	console.log(did);
	db.get(did).then(function (doc) {
		
		console.log(doc);
		var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'  }
		coolDate = new Date(parseInt(doc.date)).toLocaleDateString("en-US", options);
		l = getLevel(doc.score);
		tbl = '<h3 class="rounded p-3 m-3 ' + l + ' text-white text-center ">' + doc.diagnoses + '</h3>';
		tbl += '<table class="table bg-white">';
		var qu = 0;
		doc.answers.forEach(function(e,index){
			width = parseInt(e.value) * 20;
			ans = parseInt(e.value);
			sayit = getAnswer(ans);
			q = getQuestion(qu);
			tbl += '<div class="mb-2">';
			tbl += '<strong>' + q + '</strong>';
			tbl += '<div class="" style="margin-left: 20px;">' + sayit + '</div>';
			tbl += '</div>';
			qu++;
		});
		tbl += '</table>';
		
		$('#diagnosesModalLabel').text(doc.diagnoses);
		$('#dateTestModal').text(coolDate);
		$('#answerSet').html(tbl);

	});
});

function getAnswer(i) {
	
	var answers = ['At no time', 
			'Some of the time', 
			'Slightly less than half the time', 
			'Slightly more than half the time',
			'Most of the time',
			'All the time'];

	return answers[i];

}
function getQuestion(i) {
	
	var questions = ['1. Have you felt low in spirits or sad?',
			'2. Have you lost interest in your daily activities?',
			'3. Have you felt lacking in energy and strength?',
			'4. Have you felt less self-confident?',
			'5. Have you had a bad conscience or feelings of guilt?',
			'6. Have you felt that life wasnâ€™t worth living?',
			'7. Have you had difficulty in concentrating?',
			'8. a) Have you felt very restless?',
			'8. b)Have you felt subdued or slowed down?',
			'9. Have you had trouble sleeping at night?',
			'10. a)Have you suffered from reduced appetite?',
			'10. b)Have you suffered from increased appetite?'];

	return questions[i];

}
});
function getLevel(total) {

	level = "bg-success";
	if(total>=20 && total<25) {
		level = "bg-warning";
	}
	if(total>=25 && total<30) {
		level = "bg-danger";
	}
	if(total>=30) {
		level = "bg-dark";
	}
	return level;
	
}
</script>
</body>
</html>
